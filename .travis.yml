language: node_js

node_js:
    - "11"
    - "10"
    - "9"

services: redis-server

env:
    - REDIS_DSN=redis://localhost:6379

sudo: false
if: tag IS blank

branches:
    only:
        - master

install:
    - npm i

stages:
    - test
    - release

jobs:
    include:
        -   stage: test
            node_js: 11
            script: npm run test
        -   stage: test
            node_js: 10
            script: npm run test
        -   stage: release
            node_js: 10
            script: npm run coverage
        -   stage: test
            node_js: 9
            script: npm run test

        -   stage: release
            node_js: 10
            script: npm run build
        -   stage: release
            node_js: 10
            script: |
                npm i -g semantic-release@15 @semantic-release/npm @semantic-release/changelog @semantic-release/git @semantic-release/changelog @semantic-release/commit-analyzer @semantic-release/release-notes-generator
                npx semantic-release
